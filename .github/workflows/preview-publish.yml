name: Preview Publish

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to publish preview packages for'
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number || github.event.inputs.pr_number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  publish:
    name: Publish Preview Packages
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event.issue.pull_request && contains(github.event.comment.body, '/publish-preview'))
    runs-on: ubuntu-latest
    steps:
      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      # Checkout main first to get scripts
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: lts/*
          cache: "pnpm"

      - name: Get PR details
        id: pr_details
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr.outputs.number }}
            });

            core.setOutput('base_ref', pr.data.base.ref);
            core.setOutput('head_sha', pr.data.head.sha);

      # Now checkout the PR code
      - name: Checkout PR
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 0
          ref: ${{ steps.pr_details.outputs.head_sha }}

      - name: Fetch base branch
        run: |
          git fetch origin ${{ steps.pr_details.outputs.base_ref }}:refs/remotes/origin/${{ steps.pr_details.outputs.base_ref }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Detect changed packages
        id: changed_packages
        run: |
          BASE_REF="origin/${{ steps.pr_details.outputs.base_ref }}"
          HEAD_SHA="${{ steps.pr_details.outputs.head_sha }}"
          
          RESULT=$(node .github/scripts/preview-publish/detect-changed-packages.ts "$BASE_REF" "$HEAD_SHA")
          echo "$RESULT" | jq '.'
          
          HAS_CHANGES=$(echo "$RESULT" | jq -r '.hasChanges')
          PACKAGE_NAMES=$(echo "$RESULT" | jq -r '.packages | join(" ")')
          
          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
          echo "package_names=$PACKAGE_NAMES" >> $GITHUB_OUTPUT

      - name: Build changed packages
        if: steps.changed_packages.outputs.has_changes == 'true'
        run: |
          # Set turbo SCM env vars for --affected
          export TURBO_SCM_BASE=origin/${{ steps.pr_details.outputs.base_ref }}
          export TURBO_SCM_HEAD=${{ steps.pr_details.outputs.head_sha }}
          
          echo "Building affected packages: $TURBO_SCM_HEAD against $TURBO_SCM_BASE"
          pnpm turbo run build --affected

      - name: Get package paths for publish
        if: steps.changed_packages.outputs.has_changes == 'true'
        id: package_paths
        run: |
          PACKAGE_NAMES="${{ steps.changed_packages.outputs.package_names }}"
          
          RESULT=$(node .github/scripts/preview-publish/map-package-paths.ts "$PACKAGE_NAMES")
          echo "$RESULT" | jq '.'
          
          PACKAGE_PATHS=$(echo "$RESULT" | jq -r '.packagePaths | join(" ")')
          echo "package_paths=$PACKAGE_PATHS" >> $GITHUB_OUTPUT

      - name: Publish preview packages
        if: steps.changed_packages.outputs.has_changes == 'true'
        run: |
          PACKAGE_PATHS="${{ steps.package_paths.outputs.package_paths }}"
          pnpx pkg-pr-new publish --pnpm --packageManager="pnpm" --compact --comment=create $PACKAGE_PATHS